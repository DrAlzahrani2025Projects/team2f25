# /usr/local/apache2/conf/extra/team2.conf

DocumentRoot "/usr/local/apache2/htdocs"
<Directory "/usr/local/apache2/htdocs">
    Require all granted
</Directory>

# Load required modules (add to main httpd.conf if not already loaded)
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule headers_module modules/mod_headers.so

ProxyRequests Off
ProxyPreserveHost On
AllowEncodedSlashes NoDecode

# Set forwarded headers
RequestHeader set X-Forwarded-Proto "https"
RequestHeader set X-Forwarded-Port "443"

# Enable rewrite engine
RewriteEngine On

# Redirects to add trailing slash
RedirectMatch 301 ^/team2f25$ /team2f25/
RedirectMatch 301 ^/team2f25/jupyter$ /team2f25/jupyter/

# JUPYTER Configuration (served under /team2f25/jupyter/)
ProxyPass /team2f25/jupyter/ http://team2-jupyter:8888/
ProxyPassReverse /team2f25/jupyter/ http://team2-jupyter:8888/

# Jupyter WebSocket support (for notebooks)
RewriteCond %{HTTP:Upgrade} =websocket [NC]
RewriteCond %{REQUEST_URI} ^/team2f25/jupyter/ [NC]
RewriteRule ^/team2f25/jupyter/(.*) ws://team2-jupyter:8888/$1 [P,L]

# STREAMLIT Configuration (served under /team2f25/)
# Important: This must come AFTER Jupyter to avoid conflicts
ProxyPass /team2f25/ http://team2-app:2502/
ProxyPassReverse /team2f25/ http://team2-app:2502/

# Streamlit WebSocket support (exclude jupyter paths)
RewriteCond %{HTTP:Upgrade} =websocket [NC]
RewriteCond %{REQUEST_URI} !^/team2f25/jupyter/ [NC]
RewriteRule ^/team2f25/(.*) ws://team2-app:2502/$1 [P,L]
